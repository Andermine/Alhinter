anchors:
  - &deep-ocean-biome TEST_EQ_DEEP_OCEAN
  - &deep-ocean-tag BIOME:TEST_EQ_DEEP_OCEAN
  - &deep-ocean-biomes
    - TEST_EQ_DEEP_OCEAN: 1
  - &deep-ocean-biome-count 1

  - &ocean-biome TEST_EQ_OCEAN
  - &ocean-tag BIOME:TEST_EQ_OCEAN
  - &ocean-biomes
    - TEST_EQ_OCEAN: 1
  - &ocean-biome-count 1

  - &flat-biome TEST_EQ_PLAIN
  - &flat-tag BIOME:TEST_EQ_PLAIN
  - &flat-biomes
    - TEST_EQ_FLAT: 1
    - TEST_EQ_PLAIN: 1
  - &flat-biome-count 2

  - &hills-small-biome TEST_EQ_TERRACED_HILLS
  - &hills-small-tag BIOME:TEST_EQ_TERRACED_HILLS
  - &hills-small-biomes
    - TEST_EQ_BUTTES: 1
    - TEST_EQ_DUNES: 1
    - TEST_EQ_ERODED_BUTTES: 1
    - TEST_EQ_ERODED_PILLARS: 1
    - TEST_EQ_SPIKEY_DUNES: 1
    - TEST_EQ_TERRACED_HILLS: 1
  - &hills-small-biome-count 6

  - &large-hills-biome TEST_EQ_HILLS
  - &large-hills-tag BIOME:TEST_EQ_HILLS
  - &large-hills-biomes
    - TEST_EQ_HILLS: 1
    - TEST_EQ_SPIKES: 1
  - &large-hills-biome-count 2

  - &mountains-small-biome TEST_EQ_ERODED_TERRACED_MOUNTAINS
  - &mountains-small-tag BIOME:TEST_EQ_ERODED_TERRACED_MOUNTAINS
  - &mountains-small-biomes
    - TEST_EQ_ERODED_MOUNTAINS: 1
    - TEST_EQ_ERODED_TERRACED_MOUNTAINS: 1
    - TEST_EQ_MOUNTAINS: 1
    - TEST_EQ_TERRACED_MOUNTAINS: 1
  - &mountains-small-biome-count 4

  - &mountains-large-biome TEST_EQ_ALPHA_MOUNTAINS
  - &mountains-large-tag BIOME:TEST_EQ_ALPHA_MOUNTAINS
  - &mountains-large-biomes
    - TEST_EQ_ALPHA_MOUNTAINS: 1
    - TEST_EQ_CRACKED_PLATEAU: 1
  - &mountains-large-biome-count 2

  - &elevation-noise
    dimensions: 2
    type: OPEN_SIMPLEX_2
    frequency: 0.01

  - &variant-noise
    dimensions: 2
    type: CELLULAR
    return: CellValue
    frequency: 0.02

biomes:
  type: PIPELINE
  resolution: 2
  initial-size: 50
  blend:
    amplitude: 1
    noise:
      type: GAUSSIAN
  pipeline:
    source:
      type: NOISE
      biomes:
        - *deep-ocean-biome: *deep-ocean-biome-count
        - *ocean-biome: *ocean-biome-count
        - *flat-biome: *flat-biome-count
        - *hills-small-biome: *hills-small-biome-count
        - *large-hills-biome: *large-hills-biome-count
        - *mountains-small-biome: *mountains-small-biome-count
        - *mountains-large-biome: *mountains-large-biome-count
      noise: *elevation-noise
    stages:
      - type: REPLACE
        noise: *variant-noise
        from: *deep-ocean-tag
        to: *deep-ocean-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *ocean-tag
        to: *ocean-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *flat-tag
        to: *flat-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *hills-small-tag
        to: *hills-small-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *large-hills-tag
        to: *large-hills-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *mountains-small-tag
        to: *mountains-small-biomes

      - type: REPLACE
        noise: *variant-noise
        from: *mountains-large-tag
        to: *mountains-large-biomes

      - type: REPLACE_LIST
        variables: &riverVariables
          riverWidth: 3
          riverFrequency: 0.7
        
        default-from: USE_RIVER
        default-to:
          - SELF: 1
          - TEST_EQ_RIVER: 1
        to:
          TEST_EQ_ERODED_TERRACED_MOUNTAINS:
            - SELF: 1
            - TEST_EQ_ERODED_TERRACED_MOUNTAINS_RIVER: 1
          TEST_EQ_ALPHA_MOUNTAINS:
            - SELF: 1
            - TEST_EQ_ALPHA_MOUNTAINS_RIVER: 1
          TEST_EQ_CRACKED_PLATEAU:
            - SELF: 1
            - TEST_EQ_CRACKED_PLATEAU_RIVER: 1
        noise:
          type: EXPRESSION
          expression: if(noise(x/riverWidth, z/riverWidth)!=0,1,-1)
          variables: *riverVariables
          samplers:
            noise:
              dimensions: 2
              type: KERNEL # Edge detection
              kernel: [
                [ 0,  1, 0 ],
                [ 1, -4, 1 ],
                [ 0,  1, 0 ]
              ]
              function:
                type: EXPRESSION
                expression: noise(x*riverWidth*riverFrequency, z*riverWidth*riverFrequency)>0
                variables: *riverVariables
                samplers:
                  noise:
                    dimensions: 2
                    type: DOMAIN_WARP
                    amplitude: 2
                    function:
                      type: OPEN_SIMPLEX_2
                    warp:
                      type: OPEN_SIMPLEX_2
                      frequency: 0.14